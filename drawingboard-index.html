<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Drawing App - DrawingBoard.js</title>
    
    <!-- jQuery is required for drawingboard.js -->
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    
    <!-- DrawingBoard.js CSS -->
    <link rel="stylesheet" href="node_modules/drawingboard.js/dist/drawingboard.min.css">
    
    <!-- Custom CSS -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Room controls styling */
        #room-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #room-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #room-controls button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        
        #room-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        #room-controls button:active {
            transform: scale(0.95);
        }
        
        /* Drawing board container */
        #drawing-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #main-board {
            width: 90vw;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* Custom DrawingBoard controls styling */
        .drawing-board-controls {
            background: linear-gradient(to right, #f8f9fa, #e9ecef) !important;
            border-top: 1px solid #dee2e6 !important;
            padding: 10px !important;
        }
        
        .drawing-board-control {
            margin: 0 5px !important;
        }
        
        .drawing-board-control-colors-picker {
            border-radius: 8px !important;
            overflow: hidden !important;
        }
        
        .drawing-board-control-size-dropdown select {
            border-radius: 5px !important;
            padding: 5px 10px !important;
        }
        
        .drawing-board-control-navigation button {
            border-radius: 5px !important;
            background: #6c757d !important;
            color: white !important;
            padding: 5px 15px !important;
            transition: all 0.2s !important;
        }
        
        .drawing-board-control-navigation button:hover {
            background: #5a6268 !important;
            transform: translateY(-1px) !important;
        }
        
        /* Status indicator */
        #connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }
        
        .status-dot.connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        /* Collaboration cursors */
        .remote-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0, 123, 255, 0.5);
            pointer-events: none;
            z-index: 1000;
            transition: all 0.1s ease-out;
        }
        
        .remote-cursor::after {
            content: attr(data-user);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            #room-controls {
                top: 10px;
                right: 10px;
                left: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #main-board {
                width: 95vw;
                height: 70vh;
            }
            
            #connection-status {
                bottom: 10px;
                left: 10px;
                font-size: 12px;
            }
        }
        
        /* Custom features panel */
        #features-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 999;
            width: 200px;
        }
        
        #features-panel h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }
        
        .feature-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .feature-section label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .effect-toggle {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .effect-toggle:hover {
            background: #e0e0e0;
        }
        
        .effect-toggle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
    </style>
</head>
<body>
    <!-- Room controls -->
    <div id="room-controls">
        <input type="text" id="room-id" placeholder="Enter Room ID">
        <button id="join-room">Join Room</button>
        <button id="create-room">Create Room</button>
        <button id="copy-link">Copy Link</button>
    </div>
    
    <!-- Connection status -->
    <div id="connection-status">
        <span class="status-dot"></span>
        <span id="status-text">Offline</span>
    </div>
    
    <!-- Features panel -->
    <div id="features-panel">
        <h3>Drawing Features</h3>
        
        <div class="feature-section">
            <label>Special Effects</label>
            <button class="effect-toggle" data-effect="glow">Glow</button>
            <button class="effect-toggle" data-effect="rainbow">Rainbow</button>
            <button class="effect-toggle" data-effect="pattern">Pattern</button>
        </div>
        
        <div class="feature-section">
            <label>Canvas Effects</label>
            <button id="mirror-mode">Mirror Mode</button>
            <button id="kaleidoscope">Kaleidoscope</button>
        </div>
        
        <div class="feature-section">
            <label>Export Options</label>
            <button id="export-png">Export as PNG</button>
            <button id="export-svg">Export as SVG</button>
        </div>
    </div>
    
    <!-- Main drawing container -->
    <div id="drawing-container">
        <div id="main-board"></div>
    </div>
    
    <!-- Load DrawingBoard.js -->
    <script src="node_modules/drawingboard.js/dist/drawingboard.min.js"></script>
    
    <!-- Custom Effects Control -->
    <script src="drawingboard-effects-control.js"></script>
    
    <!-- WebPubSub for collaboration -->
    <script src="webpubsub-simple.js"></script>
    
    <!-- Collaboration Bridge -->
    <script src="collaboration-bridge-db.js"></script>
    
    <!-- Custom drawing enhancements -->
    <script>
        // Initialize DrawingBoard with custom configuration
        let board = new DrawingBoard.Board('main-board', {
            controls: [
                'Color',
                { Size: { type: 'range', min: 1, max: 50 } },
                { DrawingMode: { pencil: true, eraser: true, filler: true } },
                'Effects',
                'Navigation',
                'Download'
            ],
            size: 3,
            color: '#000000',
            background: '#ffffff',
            eraserColor: 'background',
            webStorage: 'session',
            droppable: true,
            enlargeYourContainer: false
        });
        
        // Custom effects state
        let activeEffects = new Set();
        let mirrorMode = false;
        let kaleidoscopeMode = false;
        
        // Track drawing state for collaboration
        let isDrawing = false;
        let lastPoint = null;
        let drawingData = [];
        
        // Override drawing events for collaboration
        board.ev.bind('board:startDrawing', function(e) {
            isDrawing = true;
            const rect = board.canvas.getBoundingClientRect();
            lastPoint = {
                x: e.coords.x,
                y: e.coords.y
            };
            drawingData = [lastPoint];
            
            // Send to collaboration bridge
            if (window.collaborationBridge && window.collaborationBridge.initialized) {
                window.collaborationBridge.onDrawStart(
                    lastPoint.x, 
                    lastPoint.y, 
                    board.ctx.strokeStyle, 
                    board.ctx.lineWidth
                );
            }
        });
        
        board.ev.bind('board:drawing', function(e) {
            if (!isDrawing) return;
            
            const currentPoint = {
                x: e.coords.x,
                y: e.coords.y
            };
            
            drawingData.push(currentPoint);
            
            // Apply special effects
            if (activeEffects.size > 0) {
                applySpecialEffects(lastPoint, currentPoint);
            }
            
            // Apply mirror mode
            if (mirrorMode) {
                applyMirrorEffect(lastPoint, currentPoint);
            }
            
            // Apply kaleidoscope
            if (kaleidoscopeMode) {
                applyKaleidoscopeEffect(lastPoint, currentPoint);
            }
            
            lastPoint = currentPoint;
            
            // Send to collaboration bridge
            if (window.collaborationBridge && window.collaborationBridge.initialized) {
                window.collaborationBridge.onDrawMove(currentPoint.x, currentPoint.y);
            }
        });
        
        board.ev.bind('board:stopDrawing', function() {
            isDrawing = false;
            
            // Send to collaboration bridge
            if (window.collaborationBridge && window.collaborationBridge.initialized) {
                window.collaborationBridge.onDrawEnd(drawingData);
            }
            
            drawingData = [];
            lastPoint = null;
        });
        
        // Special effects functions
        function applySpecialEffects(from, to) {
            const ctx = board.ctx;
            ctx.save();
            
            if (activeEffects.has('glow')) {
                // Add glow effect
                ctx.shadowBlur = 20;
                ctx.shadowColor = ctx.strokeStyle;
                ctx.globalAlpha = 0.5;
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
            
            if (activeEffects.has('rainbow')) {
                // Rainbow effect
                const hue = (Date.now() / 10) % 360;
                ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            }
            
            if (activeEffects.has('pattern')) {
                // Pattern brush effect
                const pattern = createPatternBrush(ctx);
                if (pattern) {
                    ctx.strokeStyle = pattern;
                }
            }
            
            ctx.restore();
        }
        
        function createPatternBrush(ctx) {
            const patternCanvas = document.createElement('canvas');
            patternCanvas.width = 10;
            patternCanvas.height = 10;
            const patternCtx = patternCanvas.getContext('2d');
            
            // Create a simple dot pattern
            patternCtx.fillStyle = ctx.strokeStyle;
            patternCtx.fillRect(0, 0, 5, 5);
            patternCtx.fillRect(5, 5, 5, 5);
            
            return ctx.createPattern(patternCanvas, 'repeat');
        }
        
        function applyMirrorEffect(from, to) {
            const ctx = board.ctx;
            const centerX = board.canvas.width / 2;
            
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(centerX * 2 - from.x, from.y);
            ctx.lineTo(centerX * 2 - to.x, to.y);
            ctx.stroke();
            ctx.restore();
        }
        
        function applyKaleidoscopeEffect(from, to) {
            const ctx = board.ctx;
            const centerX = board.canvas.width / 2;
            const centerY = board.canvas.height / 2;
            const segments = 6;
            
            ctx.save();
            
            for (let i = 0; i < segments; i++) {
                const angle = (Math.PI * 2 / segments) * i;
                
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle);
                ctx.translate(-centerX, -centerY);
                
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.stroke();
                
                // Mirror within segment
                ctx.scale(-1, 1);
                ctx.translate(-board.canvas.width, 0);
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.stroke();
                
                ctx.restore();
            }
            
            ctx.restore();
        }
        
        // Effect toggles
        document.querySelectorAll('.effect-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                const effect = this.dataset.effect;
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    activeEffects.add(effect);
                } else {
                    activeEffects.delete(effect);
                }
            });
        });
        
        document.getElementById('mirror-mode').addEventListener('click', function() {
            mirrorMode = !mirrorMode;
            this.style.background = mirrorMode ? 
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 
                '#f0f0f0';
            this.style.color = mirrorMode ? 'white' : 'black';
        });
        
        document.getElementById('kaleidoscope').addEventListener('click', function() {
            kaleidoscopeMode = !kaleidoscopeMode;
            this.style.background = kaleidoscopeMode ? 
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 
                '#f0f0f0';
            this.style.color = kaleidoscopeMode ? 'white' : 'black';
        });
        
        // Export functions
        document.getElementById('export-png').addEventListener('click', function() {
            board.downloadImg();
        });
        
        document.getElementById('export-svg').addEventListener('click', function() {
            // SVG export would require additional implementation
            alert('SVG export coming soon!');
        });
        
        // Room controls
        document.getElementById('create-room').addEventListener('click', () => {
            const roomId = window.collaborationBridge.generateRoomId();
            window.collaborationBridge.initialize(roomId);
            window.history.replaceState({}, '', `?room=${roomId}`);
            document.getElementById('room-id').value = roomId;
            updateConnectionStatus(true);
        });
        
        document.getElementById('join-room').addEventListener('click', () => {
            const roomId = document.getElementById('room-id').value;
            if (roomId) {
                window.collaborationBridge.initialize(roomId);
                window.history.replaceState({}, '', `?room=${roomId}`);
                updateConnectionStatus(true);
            }
        });
        
        document.getElementById('copy-link').addEventListener('click', () => {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Room link copied to clipboard!');
            });
        });
        
        // Connection status update
        function updateConnectionStatus(connected) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('status-text');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Offline';
            }
        }
        
        // Handle remote drawing
        window.handleRemoteDrawing = function(drawData, userId) {
            const { action, x, y, color, lineWidth, points } = drawData;
            const ctx = board.ctx;
            
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            switch (action) {
                case 'start':
                    // Could show remote cursor here
                    break;
                    
                case 'move':
                    // Draw remote strokes
                    if (points && points.length > 1) {
                        ctx.beginPath();
                        ctx.moveTo(points[0].x, points[0].y);
                        for (let i = 1; i < points.length; i++) {
                            ctx.lineTo(points[i].x, points[i].y);
                        }
                        ctx.stroke();
                    }
                    break;
                    
                case 'end':
                    // Final stroke
                    if (points && points.length > 1) {
                        ctx.beginPath();
                        ctx.moveTo(points[0].x, points[0].y);
                        for (let i = 1; i < points.length; i++) {
                            ctx.lineTo(points[i].x, points[i].y);
                        }
                        ctx.stroke();
                    }
                    break;
            }
            
            ctx.restore();
        };
        
        // Check for room ID in URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        if (roomId) {
            document.getElementById('room-id').value = roomId;
            window.collaborationBridge.initialize(roomId);
            updateConnectionStatus(true);
        }
    </script>
</body>
</html>